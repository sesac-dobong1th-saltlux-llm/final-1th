<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>ê¼¬ì§ˆë´‡ - ê¼¬ë¦¬ì§ˆë¬¸</title>
    <link rel="stylesheet" href="/css/new_tail_questions.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        #counBtn {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 48
        }

        
.loader {
    display: none;
  position: relative;
  display: flex;
  align-items: center;
  left: -45%;
  gap: 8px;
}

.bar {
  width: 15px;
  height: 35px;
  background-color: #3bcbdb;
  animation: loading 0.8s infinite ease-in-out;
}

.bar-1 {
  animation-delay: 0.15s;
}
.bar-2 {
  animation-delay: 0.3s;
}
.bar-3 {
  animation-delay: 0.45s;
}

@keyframes loading {
  0%,
  80%,
  100% {
    height: 32px;
  }
  40% {
    height: 52px;
  }
}


    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="chat-container"></div>
    <div class="typing-container">
        <div class="typing-content">
            <div class="typing-textarea">
                <textarea id="chatInput" spellcheck="false" placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”ğŸ˜" minlength="200" maxlength="500"></textarea>
                <span id="sendBtn" class="material-symbols-rounded">send</span>
                <div class="loader">
                    <div class="bar bar-1"></div>
                    <div class="bar bar-2"></div>
                    <div class="bar bar-3"></div>
                </div>
            </div>
            <div class="typing-controls">
                <span id="theme-btn" class="material-symbols-rounded" title="ë¼ì´íŠ¸/ë‹¤í¬ í…Œë§ˆ">light_mode</span>
                <span id="startBtn" class="material-symbols-rounded" style="font-size: 48px;"
                    title="ë…¹ìŒì‹œì‘">arrow_right</span>
                <span id="countBtn" title="ë‚¨ì€ì‹œê°„ì€ ë³´ì—¬ì¤ë‹ˆë‹¤.">90</span>
                <span id="stopBtn" class="material-symbols-rounded" title="ë…¹ìŒ ì¢…ë£Œ">stop_circle</span>
                <span id="backBtn" class="material-symbols-rounded" title="ë’¤ë¡œ ê°€ê¸°">arrow_back</span>

            </div>
        </div>
        <script>
            $(document).ready(function () {
                // ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™”
                var chatInput = $("#chatInput");
                var sendButton = $("#sendBtn");
                var chatContainer = $(".chat-container");
                var themeButton = $("#theme-btn");
                var backBtn = $("#backBtn");
                var initialInputHeight = chatInput.prop('scrollHeight');


                let mediaRecorder;
        let audioChunks = [];
        let recordingTime = 90;
        let countdownInterval;

        $('#startBtn').on('click', async function () {
            $('.loader').show(); // ë¡œë” ë³´ì´ê¸°
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async function () {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob);

                    try {
                        const response = await fetch('/audio', {
                            method: 'POST',
                            body: formData
                        });
                        const resultText = await response.text();
                        $('#chatInput').val(resultText);
                        console.log(resultText);
                    } catch (error) {
                        console.error('Error:', error);
                    }
                    audioChunks = [];
                    $('.loader').hide(); // ë¡œë” ìˆ¨ê¸°ê¸°
                };

                mediaRecorder.start();
                $('#countBtn').css('color', 'red');
                countdownInterval = setInterval(() => {
                    recordingTime--;
                    $('#countBtn').text(recordingTime);
                    if (recordingTime === 0) {
                        clearInterval(countdownInterval);
                        mediaRecorder.stop();
                        $('#countBtn').css('color', '');
                        $('#countBtn').text('90');
                        recordingTime = 90;
                    }
                }, 1000);
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        });

        $('#stopBtn').on('click', function () {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            clearInterval(countdownInterval);
            $('#countBtn').css('color', '');
            $('#countBtn').text('90');
            recordingTime = 90;
        });


                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
                var loadDataFromLocalstorage = function () {
                    // í˜„ì¬ URLì—ì„œ ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸(ID) ì¶”ì¶œ
                    const currentUrl = window.location.pathname;
                    const segments = currentUrl.split('/');
                    const iq_id = segments[segments.length - 1];

                    // AJAX ìš”ì²­ì„ í†µí•´ ì´ˆê¸° ì§ˆë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    $.ajax({
                        url: `/get_tail_questions/${iq_id}`,
                        type: 'GET',
                        success: function (data) {
                            // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„¤ì • ë° í…Œë§ˆ ì ìš©
                            var defaultText = `<div class="chat incoming">
                <div class="chat-content">
                    <div class="chat-details">
                        <img src="/images/goliebot.png" alt="chatbot-img">
                        <p>${data.questions[0].iq_text}</p>
                    </div>
                </div>
            </div>`;
                            var themeColor = localStorage.getItem("themeColor");
                            themeColor === "light_mode" ? $('body').addClass("light-mode") : $('body').removeClass("light-mode");
                            themeButton.text(themeColor === "light_mode" ? "dark_mode" : "light_mode");

                            // ì±„íŒ… ì»¨í…Œì´ë„ˆì— ìƒˆë¡œìš´ ì§ˆë¬¸ì„ ìµœìƒë‹¨ì— ì¶”ê°€
                            chatContainer.prepend(defaultText);
                            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                        }
                    });
                };

                var showIfQuestions = function () {
                    const currentUrl = window.location.pathname;
                    const segments = currentUrl.split('/');
                    const iq_id = segments[segments.length - 1];
                    // AJAX ìš”ì²­ì„ í†µí•´ ì´ˆê¸° ì§ˆë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    $.ajax({
                        url: `/show_if_question/${iq_id}`,
                        type: 'GET',
                        success: function (data) {
                            if (data.questions && data.questions.length > 0) {
                                var allChatsHtml = data.questions.reduce((html, question) => {
                                    return html + `

<div class="chat outgoing">
    <div class="chat-content">
        <div class="chat-details">
            <img src="/images/usericon.png" alt="user-img">
            <p>${question.eq_answer}</p>
        </div>
    </div>
</div>
<div class="chat incoming">
    <div class="chat-content">
        <div class="chat-details">
            <img src="/images/goliebot.png" alt="chatbot-img">
            <p>${question.eq_text}</p>
        </div>
    </div>
</div>
`;
                                }, '');

                                // ê¸°ì¡´ ì±„íŒ…ì— ìƒˆë¡œìš´ ì±„íŒ… ì¶”ê°€
                                var existingChats = localStorage.getItem("all-chats");
                                if (existingChats) {
                                    chatContainer.prepend(allChatsHtml); // ìˆ˜ì •: ìµœìƒë‹¨ì— ì¶”ê°€
                                } else {
                                    chatContainer.html(allChatsHtml); // ìƒˆë¡œìš´ ì±„íŒ…ìœ¼ë¡œ ì´ˆê¸°í™”
                                }
                                chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                            }
                        }

                    });

                }

                // ì±„íŒ… ìš”ì†Œ ìƒì„± í•¨ìˆ˜
                var createChatElement = function (content, className) {
                    return $('<div class="chat ' + className + '">' + content + '</div>');
                };

                // ì„œë²„ë¡œë¶€í„° ì±„íŒ… ì‘ë‹µ ë°›ê¸° í•¨ìˆ˜
                var getChatResponse = function (incomingChatDiv, userText) {
                    // URL êµ¬ì„± ë° ì¸ì½”ë”©
                    const currentUrl = window.location.pathname;
                    const segments = currentUrl.split('/');
                    const iq_id = segments[segments.length - 1];
                    var API_URL = `/send_tail_questions/${iq_id}?chatInput=${encodeURIComponent(userText)}`;

                    // GET ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ë°ì´í„° ìš”ì²­
                    fetch(API_URL, { method: 'GET' })
                        .then(response => response.json())
                        .then(data => {
                            // ì‘ë‹µ ì²˜ë¦¬ ë° ì±„íŒ… ì°½ ì—…ë°ì´íŠ¸
                            var pElement = $('<p></p>').text(data.result);
                            incomingChatDiv.find(".typing-animation").remove();
                            incomingChatDiv.find(".chat-details").append(pElement);
                            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                        })
                        .catch(error => {
                            // ì˜¤ë¥˜ ì²˜ë¦¬
                            var pElement = $('<p></p>').addClass("error").text("Oops! Something went wrong while retrieving the response. Please try again.");
                            incomingChatDiv.find(".typing-animation").remove();
                            incomingChatDiv.find(".chat-details").append(pElement);
                        });
                };

                // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ í•¨ìˆ˜
                var showTypingAnimation = function (userText) {
                    // ì• ë‹ˆë©”ì´ì…˜ HTML êµ¬ì„±
                    var html = `<div class="chat-content">
                        <div class="chat-details">
                            <img src="/images/goliebot.png" alt="chatbot-img">
                            <div class="typing-animation">
                                <div class="typing-dot" style="--delay: 0.2s"></div>
                                <div class="typing-dot" style="--delay: 0.3s"></div>
                                <div class="typing-dot" style="--delay: 0.4s"></div>
                            </div>
                        </div>
                        <span onclick="copyResponse(this)" class="material-symbols-rounded">content_copy</span>
                    </div>`;
                    var incomingChatDiv = createChatElement(html, "incoming");
                    chatContainer.append(incomingChatDiv);
                    chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                    getChatResponse(incomingChatDiv, userText);
                };

                // ì‚¬ìš©ì ë°œì‹  ì±„íŒ… ì²˜ë¦¬ í•¨ìˆ˜
                var handleOutgoingChat = function () {
                    var userText = chatInput.val().trim();
                    if (!userText) return;
                    chatInput.val('');
                    chatInput.css('height', initialInputHeight + 'px');
                    var html = `<div class="chat-content">
                        <div class="chat-details">
                            <img src="/images/usericon.png" alt="user-img">
                            <p>${userText}</p>
                        </div>
                    </div>`;
                    var outgoingChatDiv = createChatElement(html, "outgoing");
                    chatContainer.find(".default-text").remove();
                    chatContainer.append(outgoingChatDiv);
                    chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                    setTimeout(function () { showTypingAnimation(userText); }, 500);
                };

                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                backBtn.on("click", function () {
                    if (confirm("ì´ì „ ëŒ€í™”ë°©ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        history.go(-1);
                    }
                });

                // í…Œë§ˆ ë²„íŠ¼ í† ê¸€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                themeButton.on("click", function () {
                    $('body').toggleClass("light-mode");
                    localStorage.setItem("themeColor", themeButton.text());
                    themeButton.text($('body').hasClass("light-mode") ? "dark_mode" : "light_mode");
                });

                // ì…ë ¥ í•„ë“œ ë™ì  í¬ê¸° ì¡°ì •
                chatInput.on("input", function () {
                    chatInput.css('height', initialInputHeight + 'px');
                    chatInput.css('height', chatInput.prop('scrollHeight') + 'px');
                });

                // ì—”í„° í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
                chatInput.on("keydown", function (e) {
                    if (e.key === "Enter" && !e.shiftKey && $(window).width() > 800) {
                        e.preventDefault();
                        handleOutgoingChat();
                    }
                });

                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                showIfQuestions();
                loadDataFromLocalstorage();
                // ë°œì‹  ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
                sendButton.on("click", handleOutgoingChat);
            });
        </script>

</body>

</html>